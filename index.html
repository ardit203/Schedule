<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <!--    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;700&display=swap" rel="stylesheet">-->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="./styles.css" rel="stylesheet">


</head>
<body>
<div id="main" class="grid"></div>
<script>
    let times = [
        "8:00 - 8:45",
        "9:00 - 9:45",
        "10:00 - 10:45",
        "11:00 - 11:45",
        "12:00 - 12:45",
        "13:00 - 13:45",
        "14:00 - 14:45",
        "15:00 - 15:45",
        "16:00 - 16:45",
        "17:00 - 17:45",
        "18:00 - 18:45",
        "19:00 - 19:45",
        "20:00 - 20:45",
    ]
    let startPeriod = 0 //inclusive
    let endPeriod = 13 //exclusive
    let startDayCode = -1 //inclusive
    let endDayCode = 5 //exclusive
    let days = null
    let mainClasses = null
    let data = null
    let main = document.getElementById("main")

    fetchJson()

    async function fetchJson() {
        let response = await fetch('./schedule.json')
        let json = await response.json()
        days = json.days
        mainClasses = json.main_classes
        data = json.data

        console.log(days)
        console.log(mainClasses)
        console.log(data)
        build()
    }

    function build() {
        //days
        createDiv('time-item corner') // blank corner

        for (const day in days) {
            createDiv('item header', day)
        }

        for (let i = startPeriod; i < endPeriod; i++) {
            for (let j = startDayCode; j < endDayCode; j++) {
                if (j === startDayCode) {
                    createDiv('time-item', times[i])
                    continue
                }
                let filter = data.filter(d => d['Day code'] === j && d['Periods'].includes(i))
                createNestedDiv(filter)
            }
        }
    }

    function createDiv(className = 'empty-item', text = "", color = "") {
        let div = document.createElement("div");
        div.innerHTML = text;
        div.className = className;          // <-- important (uses passed class)
        if (color) div.style.background = color;
        main.appendChild(div);
        return div;
    }


    function createNestedDiv(items) {
        let level = items.length
        let div = createDiv('dummy-item')
        if (level === 0) {
            div.classList.remove('dummy-item')
            div.classList.add('empty-item')
            return
        }

        for (let item of items) {
            let innerDiv = document.createElement("div")
            let id = item['Day code'].toString() + item['Start period'].toString()
            innerDiv.setAttribute("id", id)
            innerDiv.addEventListener("click", () => showLessonOverlay(id));
            innerDiv.classList.add('sub-item')
            innerDiv.style.background = contains(item['Classes'], mainClasses) ? item['Color'] : "#999999"


            let roomDiv = document.createElement("div")
            roomDiv.classList.add('small')
            roomDiv.textContent = item['Classrooms']
            innerDiv.appendChild(roomDiv)

            let name = createFields("h5", item['Short name'], 'center', 'name')
            innerDiv.appendChild(name)

            div.appendChild(innerDiv)
        }
    }

    function createFields(type, text, align, className = '') {
        let field = document.createElement(type)
        field.innerHTML = text
        field.style.textAlign = align
        field.classList.add(className)
        return field
    }

    function contains(classes, mainClasses) {
        let split = classes.split("; ")
        let filter = split.filter(s => mainClasses.includes(s))
        return filter.length > 0
    }

    // ===== Overlay / Modal JS =====
    (function initOverlay() {
        const backdrop = document.createElement("div");
        backdrop.className = "overlay-backdrop";
        backdrop.id = "lessonOverlay";

        backdrop.innerHTML = `
    <div class="overlay-card" role="dialog" aria-modal="true" aria-labelledby="overlayTitle">
      <div class="overlay-topbar">
        <div class="overlay-accent" id="overlayAccent"></div>
        <div>
          <h2 class="overlay-title" id="overlayTitle"></h2>
          <div class="overlay-subtitle" id="overlaySubtitle"></div>
        </div>
        <button class="overlay-close" type="button" id="overlayClose" aria-label="Close">×</button>
      </div>

      <div class="overlay-body">
        <div class="overlay-grid">
          <div class="overlay-label">Classroom</div>
          <div class="overlay-value" id="overlayRoom"></div>

          <div class="overlay-label">Classes</div>
          <div class="overlay-value" id="overlayClasses"></div>

          <div class="overlay-label">Professors</div>
          <div class="overlay-value" id="overlayProf"></div>
        </div>
      </div>

      <div class="overlay-footer">
        <button class="overlay-btn" type="button" id="overlayClose2">Close</button>
      </div>
    </div>
  `;

        document.body.appendChild(backdrop);

        const card = backdrop.querySelector(".overlay-card");
        const closeBtn = document.getElementById("overlayClose");
        const closeBtn2 = document.getElementById("overlayClose2");

        function hideOverlay() {
            backdrop.classList.remove("is-open");
            document.body.classList.remove("modal-open");
        }

        function showOverlay(id) {
            console.log(id)
            let dayCode = parseInt(id.split("")[0])
            let startPeriod = parseInt(id.split("")[1])
            let item = data.find(d => d['Day code'] === dayCode && d['Periods'].includes(startPeriod))
            if (item == null) {
                return
            }
            // Safe reads with fallbacks for your keys
            const title = item["Subject"] || item["Short name"] || "Lesson";
            const subtitle = item["Time"] ? `${item["Day"] || ""} • ${item["Time"]}`.trim() : (item["Day"] || "");
            const room = item["Classrooms"] || "";
            const classes = item["Classes"] || "";
            const prof = item["Teachers"] || item["Professors"] || "";

            // Fill text content (no HTML injection)
            document.getElementById("overlayTitle").textContent = title;
            document.getElementById("overlaySubtitle").textContent = subtitle;
            document.getElementById("overlayRoom").textContent = room;
            document.getElementById("overlayClasses").textContent = classes;
            document.getElementById("overlayProf").textContent = prof;

            // Accent color (optional)
            const accent = document.getElementById("overlayAccent");
            accent.style.background = item["Color"] || "#64748b";

            backdrop.classList.add("is-open");
            document.body.classList.add("modal-open");
        }

        // Close interactions
        closeBtn.addEventListener("click", hideOverlay);
        closeBtn2.addEventListener("click", hideOverlay);

        backdrop.addEventListener("click", (e) => {
            if (e.target === backdrop) hideOverlay(); // click outside card
        });

        document.addEventListener("keydown", (e) => {
            if (e.key === "Escape" && backdrop.classList.contains("is-open")) hideOverlay();
        });

        // expose functions globally so you can call them from your timetable code
        window.showLessonOverlay = showOverlay;
        window.hideLessonOverlay = hideOverlay;
    })();


</script>

</body>
</html>