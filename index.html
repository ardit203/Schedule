<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <!--    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;700&display=swap" rel="stylesheet">-->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="./styles.css" rel="stylesheet">



</head>
<body>
<div id="main"></div>
<script>
    let times = [
        "8:00 - 8:45",
        "9:00 - 9:45",
        "10:00 - 10:45",
        "11:00 - 11:45",
        "12:00 - 12:45",
        "13:00 - 13:45",
        "14:00 - 14:45",
        "15:00 - 15:45",
        "16:00 - 16:45",
        "17:00 - 17:45",
        "18:00 - 18:45",
        "19:00 - 19:45",
        "20:00 - 20:45",
    ]
    let startPeriod = 0 //inclusive
    let endPeriod = 13 //exclusive
    let startDayCode = -1 //inclusive
    let endDayCode = 5 //exclusive
    let days = null
    let data = null
    let mainClasses = null
    let filteredData = null
    let main = document.getElementById("main")
    let subjects = null
    let teachers = null
    let classrooms = null
    let classes = null
    let filters = {
        Subjects: 'all',
        Teachers: 'all',
        Classrooms: 'all',
        Classes: 'all'
    }

    fetchJson()

    async function fetchJson() {
        let response = await fetch('./schedule.json')
        let json = await response.json()

        days = json.days
        mainClasses = json.main_classes
        data = json.data
        teachers = json.teachers
        classrooms = json.classrooms
        classes = json.classes
        subjects = json.subjects

        console.log(days)
        console.log(mainClasses)
        console.log(data)
        console.log(teachers)
        console.log(classrooms)
        console.log(classes)
        console.log(subjects)
        createSearchFields()
        applyFilters()
    }

    function applyFilters() {
        filteredData = filters.Subjects === 'all' ? data : data.filter(d => d.Subject.includes(filters.Subjects))
        filteredData = filters.Teachers === 'all' ? filteredData : filteredData.filter(d => d.Teachers.includes(filters.Teachers))
        filteredData = filters.Classrooms === 'all' ? filteredData : filteredData.filter(d => d.Classrooms === filters.Classrooms)
        filteredData = filters.Classes === 'all' ? filteredData : filteredData.filter(d => d.Classes.includes(filters.Classes))
        build()
    }

    function build() {
        main.innerHTML = ""

        let table = document.createElement("table")
        let tableHead = document.createElement("tr")
        table.appendChild(tableHead)

        let blank = document.createElement("th")
        blank.classList.add("time")
        tableHead.appendChild(blank)


        for (const day in days) {
            let th = document.createElement("th")
            th.textContent = day
            tableHead.appendChild(th)
        }


        let tbody = document.createElement("tbody")
        table.appendChild(tbody)

        for (let i = startPeriod; i < endPeriod; i++) {
            let tr = document.createElement("tr")
            tbody.appendChild(tr)
            for (let j = startDayCode; j < endDayCode; j++) {
                let td = document.createElement("td")
                tr.appendChild(td)
                if (j === startDayCode) {
                    td.textContent = times[i]
                    td.classList.add("time")
                    continue
                }
                let filter = filteredData.filter(d => d['Day code'] === j && d['Periods'].includes(i))
                createNestedDiv(td, filter)
                tr.appendChild(td)
            }
        }

        main.appendChild(table)
    }

    function createDiv(className = 'empty-item', text = "", color = "") {
        let div = document.createElement("div");
        div.innerHTML = text;
        div.className = className;          // <-- important (uses passed class)
        if (color) div.style.background = color;
        main.appendChild(div);
        return div;
    }


    function createNestedDiv(td, items) {
        let level = items.length
        let div = createDiv('dummy-item')
        if (level === 0) {
            div.remove()
            return
        }

        for (let item of items) {
            let innerDiv = document.createElement("div")
            innerDiv.addEventListener("click", () => showLessonOverlay(item));
            innerDiv.classList.add('sub-item')
            innerDiv.style.background = item['Classes'] ? item['Color'] : "#999999"


            let roomDiv = document.createElement("div")
            roomDiv.classList.add('small')
            roomDiv.textContent = item['Classrooms']
            innerDiv.appendChild(roomDiv)

            let name = createFields("div", item['Short name'], 'center', 'name')
            innerDiv.appendChild(name)

            div.appendChild(innerDiv)
        }
        td.appendChild(div)
    }

    function createFields(type, text, align, className = '') {
        let field = document.createElement(type)
        field.innerHTML = text
        field.classList.add(className)
        return field
    }

    function contains(classes, mainClasses) {
        let split = classes.split("; ")
        let filter = split.filter(s => mainClasses.includes(s))
        return filter.length > 0
    }

    function createSearchFields() {
        let div = document.createElement("div")
        div.id = 'form'

        div.appendChild(createSelect(subjects, "Subjects"))
        div.appendChild(createSelect(teachers, "Teachers"))
        div.appendChild(createSelect(classrooms, "Classrooms"))
        div.appendChild(createSelect(classes, "Classes"))

        document.body.prepend(div);
    }

    function createSelect(items, labelText) {
        const wrapper = document.createElement("div");

        const label = document.createElement("label");
        label.textContent = labelText;

        const select = document.createElement("select");
        select.onchange = (e) => {
            filters[e.target.id] = e.target.value
            console.log(filters)
            applyFilters()
        };


        select.id = labelText;
        label.htmlFor = labelText;

        const placeholder = document.createElement("option");
        placeholder.value = "all";
        placeholder.textContent = "View all";
        placeholder.selected = true;
        select.appendChild(placeholder);

        const frag = document.createDocumentFragment();
        for (const item of items) {
            const opt = document.createElement("option");
            opt.value = item;
            opt.textContent = item;
            frag.appendChild(opt);
        }
        select.appendChild(frag);

        wrapper.appendChild(label);
        wrapper.appendChild(select);

        return wrapper;
    }


    // ===== Overlay / Modal JS =====
    (function initOverlay() {
        const backdrop = document.createElement("div");
        backdrop.className = "overlay-backdrop";
        backdrop.id = "lessonOverlay";

        backdrop.innerHTML = `
    <div class="overlay-card" role="dialog" aria-modal="true" aria-labelledby="overlayTitle">
      <div class="overlay-topbar">
        <div class="overlay-accent" id="overlayAccent"></div>
        <div>
          <h2 class="overlay-title" id="overlayTitle"></h2>
          <div class="overlay-subtitle" id="overlaySubtitle"></div>
        </div>
        <button class="overlay-close" type="button" id="overlayClose" aria-label="Close">×</button>
      </div>

      <div class="overlay-body">
        <div class="overlay-grid">
          <div class="overlay-label">Classroom</div>
          <div class="overlay-value" id="overlayRoom"></div>

          <div class="overlay-label">Classes</div>
          <div class="overlay-value" id="overlayClasses"></div>

          <div class="overlay-label">Professors</div>
          <div class="overlay-value" id="overlayProf"></div>
        </div>
      </div>

      <div class="overlay-footer">
        <button class="overlay-btn" type="button" id="overlayClose2">Close</button>
      </div>
    </div>
  `;

        document.body.appendChild(backdrop);

        const card = backdrop.querySelector(".overlay-card");
        const closeBtn = document.getElementById("overlayClose");
        const closeBtn2 = document.getElementById("overlayClose2");

        function hideOverlay() {
            backdrop.classList.remove("is-open");
            document.body.classList.remove("modal-open");
        }

        function showOverlay(item) {
            if (item == null) {
                return
            }
            // Safe reads with fallbacks for your keys
            const title = item["Subject"] || item["Short name"] || "Lesson";
            const subtitle = item["Time"] ? `${item["Day"] || ""} • ${item["Time"]}`.trim() : (item["Day"] || "");
            const room = item["Classrooms"] || "";
            const classes = item["Classes"] || "";
            const prof = item["Teachers"] || item["Professors"] || "";

            // Fill text content (no HTML injection)
            document.getElementById("overlayTitle").textContent = title;
            document.getElementById("overlaySubtitle").textContent = subtitle;
            document.getElementById("overlayRoom").textContent = room;
            document.getElementById("overlayClasses").textContent = classes;
            document.getElementById("overlayProf").textContent = prof;

            // Accent color (optional)
            const accent = document.getElementById("overlayAccent");
            accent.style.background = item["Color"] || "#64748b";

            backdrop.classList.add("is-open");
            document.body.classList.add("modal-open");
        }

        // Close interactions
        closeBtn.addEventListener("click", hideOverlay);
        closeBtn2.addEventListener("click", hideOverlay);

        backdrop.addEventListener("click", (e) => {
            if (e.target === backdrop) hideOverlay(); // click outside card
        });

        document.addEventListener("keydown", (e) => {
            if (e.key === "Escape" && backdrop.classList.contains("is-open")) hideOverlay();
        });

        // expose functions globally so you can call them from your timetable code
        window.showLessonOverlay = showOverlay;
        window.hideLessonOverlay = hideOverlay;
    })();


</script>

</body>
</html>